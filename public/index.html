<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweet Shop Dashboard</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>Sweet Shop</h1>
            <p>Management Dashboard</p>
        </div>
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="/" class="nav-link active">
                    <i class="fas fa-home"></i> Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a href="/inventory" class="nav-link">
                    <i class="fas fa-box"></i> Inventory
                </a>
            </li>
            <li class="nav-item">
                <a href="/sales" class="nav-link">
                    <i class="fas fa-chart-line"></i> Sales Reports
                </a>
            </li>
        </ul>
    </div>

    <div class="mobile-toggle">
        <i class="fas fa-bars"></i>
    </div>

    <div class="main-content">
        <div class="page-header">
            <h2>Dashboard</h2>
            <p>Welcome to Sweet Shop Management System</p>
        </div>

        <div class="dashboard-grid">
            <div class="stat-card">
                <h3>Total Inventory Items</h3>
                <div class="value" id="total-items">0</div>
            </div>
            <div class="stat-card">
                <h3>Total Inventory Value</h3>
                <div class="value">₹<span id="inventory-value">0.00</span></div>
            </div>
            <div class="stat-card">
                <h3>Total Sales</h3>
                <div class="value">₹<span id="total-sales">0.00</span></div>
            </div>
            <div class="stat-card">
                <h3>Total Transactions</h3>
                <div class="value" id="total-transactions">0</div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="chart-container dashboard">
                <div class="chart-header">
                    <h3>Top Selling Items</h3>
                </div>
                <canvas id="top-items-chart" class="chart"></canvas>
            </div>
            <div class="chart-container dashboard">
                <div class="chart-header">
                    <h3>Inventory Distribution</h3>
                </div>
                <canvas id="inventory-chart" class="chart"></canvas>
            </div>
        </div>

        <div class="panel">
            <h3>Recent Sales</h3>
            <table id="recent-sales-table">
                <thead>
                    <tr>
                        <th>Sweet</th>
                        <th>Quantity</th>
                        <th>Unit Price</th>
                        <th>Total</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Mobile sidebar toggle
            const mobileToggle = document.querySelector('.mobile-toggle');
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (mobileToggle) {
                mobileToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                    mainContent.classList.toggle('sidebar-active');
                });
            }

            // Fetch dashboard data
            fetchDashboardData();
        });

        // Fetch dashboard data
        async function fetchDashboardData() {
            try {
                const [inventoryResponse, salesResponse] = await Promise.all([
                    fetch('/api/inventory'),
                    fetch('/api/sales')
                ]);
                
                const inventoryData = await inventoryResponse.json();
                const salesData = await salesResponse.json();
                
                // Call function to destroy old charts
                destroyCharts();
                
                // Update stats
                updateInventoryStats(inventoryData);
                updateSalesStats(salesData);
                
                
                updateInventoryChart(inventoryData);
                
                updateTopItemsChart(salesData);
                updateRecentSalesTable(salesData.sales || []);
            } catch (error) {
                console.error('Error fetching dashboard data:', error);
            }
        }

        // Update inventory statistics
        function updateInventoryStats(inventory) {
            const totalItems = Object.keys(inventory).length;
            let totalValue = 0;
            
            for (const name in inventory) {
                const item = inventory[name];
                totalValue += item.quantity * item.price;
            }
            
            document.getElementById('total-items').textContent = totalItems;
            document.getElementById('inventory-value').textContent = totalValue.toFixed(2);
        }

        // Update sales statistics
        function updateSalesStats(data) {
            document.getElementById('total-sales').textContent = data.totalSales.toFixed(2);
            document.getElementById('total-transactions').textContent = (data.sales || []).length;
        }

        // Update recent sales table
        function updateRecentSalesTable(sales) {
            const tbody = document.querySelector('#recent-sales-table tbody');
            tbody.innerHTML = '';
            
            if (!sales || sales.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 5;
                cell.textContent = 'No sales recorded';
                cell.style.textAlign = 'center';
                cell.style.padding = '1.5rem';
                cell.style.color = 'var(--text-light)';
                row.appendChild(cell);
                tbody.appendChild(row);
                return;
            }
            
            // Show only the 5 most recent sales (reversed for most recent first)
            const recentSales = sales.slice().reverse().slice(0, 5);
            
            recentSales.forEach(sale => {
                const row = document.createElement('tr');
                
                const nameCell = document.createElement('td');
                nameCell.textContent = sale.name;
                
                const quantityCell = document.createElement('td');
                quantityCell.textContent = sale.quantity;
                
                const priceCell = document.createElement('td');
                priceCell.textContent = `$${sale.price.toFixed(2)}`;
                
                const totalCell = document.createElement('td');
                const totalAmount = sale.totalAmount || (sale.price * sale.quantity);
                totalCell.textContent = `$${totalAmount.toFixed(2)}`;
                
                const dateCell = document.createElement('td');
                dateCell.textContent = sale.timestamp ? new Date(sale.timestamp).toLocaleString() : 'N/A';
                
                row.appendChild(nameCell);
                row.appendChild(quantityCell);
                row.appendChild(priceCell);
                row.appendChild(totalCell);
                row.appendChild(dateCell);
                
                tbody.appendChild(row);
            });
        }

        function destroyCharts() {
            
            
            const topItemsChart = Chart.getChart('top-items-chart');
            if (topItemsChart) topItemsChart.destroy();
            
            const inventoryChart = Chart.getChart('inventory-chart');
            if (inventoryChart) inventoryChart.destroy();
        }

        // Update inventory chart based on actual data
        function updateInventoryChart(inventory) {
            const labels = [];
            const quantities = [];
            
            if (Object.keys(inventory).length > 0) {
                 for (const name in inventory) {
                    labels.push(name);
                    quantities.push(inventory[name].quantity);
                }
            } else {
                labels.push('No Inventory');
                quantities.push(0);
            }
            
            const ctx = document.getElementById('inventory-chart').getContext('2d');
            const inventoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: quantities,
                        backgroundColor: [
                            'rgba(99, 102, 241, 0.7)',
                            'rgba(244, 63, 94, 0.7)',
                            'rgba(16, 185, 129, 0.7)',
                            'rgba(245, 158, 11, 0.7)',
                            'rgba(139, 92, 246, 0.7)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        
        
        // Function for Top Items chart
        function updateTopItemsChart(salesData) {
            // Top Selling Items Chart
            const topItemsCtx = document.getElementById('top-items-chart').getContext('2d');
            
            // Aggregate sales by item
            const itemSales = {};
            let topItemNames = [];
            let topItemQuantities = [];
            
            if (salesData && salesData.sales && salesData.sales.length > 0) {
                // Process actual sales data
                salesData.sales.forEach(sale => {
                    if (!itemSales[sale.name]) {
                        itemSales[sale.name] = 0;
                    }
                    itemSales[sale.name] += parseInt(sale.quantity) || 0;
                });
                
                // Sort items by sales and get top 5
                const sortedItems = Object.keys(itemSales)
                    .map(name => ({ name, quantity: itemSales[name] }))
                    .sort((a, b) => b.quantity - a.quantity)
                    .slice(0, 5);
                
                if (sortedItems.length > 0) {
                    topItemNames = sortedItems.map(item => item.name);
                    topItemQuantities = sortedItems.map(item => item.quantity);
                }
            }
            
            // If no sales data, show placeholder
            if (topItemNames.length === 0) {
                topItemNames.push('No Sales Data');
                topItemQuantities.push(0);
            }
            
            new Chart(topItemsCtx, {
                type: 'bar',
                data: {
                    labels: topItemNames,
                    datasets: [{
                        label: 'Units Sold',
                        data: topItemQuantities,
                        backgroundColor: [
                            'rgba(99, 102, 241, 0.7)',
                            'rgba(244, 63, 94, 0.7)',
                            'rgba(16, 185, 129, 0.7)',
                            'rgba(245, 158, 11, 0.7)',
                            'rgba(139, 92, 246, 0.7)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>